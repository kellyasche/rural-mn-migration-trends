---
title: "Population estimates - components of change"
format: html
editor: visual
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(readxl)
library(zoo)
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", linewidth  = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", linewidth = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Shapefiles/County shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r master components of change}
county.typology <- read_csv("Data/County typology/county_typology.csv")

master.comp.change <- read_csv("Data/Components of change/Master-comp-change-county.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         edr.simple = fct_relevel(edr.simple, "EDR 1", "EDR 2", "EDR 3", "EDR 4", "EDR 5", "EDR 6E", "EDR 6W", "EDR 7E", "EDR 7W", "EDR 8", "EDR 9", "EDR 10", "EDR 11"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban")) %>%
  left_join(county.typology[,c(1,3)], by = "countyfp") %>%
  mutate(recreational = ifelse(REC_2015 == 1 & Dem_Desc == "Urban/town/rural mix", "Urban/town/rural mix - Recreational",
                               ifelse(REC_2015 == 1 & Dem_Desc == "Town/rural mix", "Town/rural mix - Recreational",
                                      ifelse(REC_2015 == 1 & Dem_Desc == "Entirely rural", "Entirely rural - Recreational", as.character(Dem_Desc)))),
         recreational = fct_relevel(recreational, "Entirely rural", "Entirely rural - Recreational", "Town/rural mix", "Town/rural mix - Recreational", "Urban/town/rural mix", "Urban/town/rural mix - Recreational", "Entirely urban"))
  
```

<br>

The following is an analysis of the components of change for Minnesota counties. The data is from the U.S. Census Bureau's Annual Population Estimates.

Each year, the United States Census Bureau produces and publishes estimates of the population for the nation, states, metropolitan and micropolitan statistical areas, counties, state/county equivalents, and Puerto Rico. We estimate the resident population for each year since the most recent decennial census by using measures of population change. The resident population includes all people currently residing in the United States.

With each annual release of population estimates, the Population Estimates Program revises and updates the entire time series of estimates from April 1, 2020 to July 1 of the current year, which we refer to as the vintage year. We use the term “vintage” to denote an entire time series created with a consistent population starting point and methodology. The release of a new vintage of estimates supersedes any previous series and incorporates the most up-to-date input data and methodological improvements.

The population estimates are used for federal funding allocations, as controls for major surveys including the Current Population Survey and the American Community Survey (ACS), for community development, to aid business planning, and as denominators for statistical rates, among many other uses. Overall, the estimates time series from 2010 to 2020 was very accurate, even accounting for ten years of population change. The mean absolute percent error (MAPE), which is the average absolute difference between the final total resident population estimates and 2020 Census counts, was only about 2.9 percent across all counties.

We produce estimates using a cohort-component method, which is derived from the demographic balancing equation:

Population base + Births - Deaths + Migration = Population estimate

<br>

**Vital Statistics**

Vital statistics encompass two of the core components of the demographic equation: births and deaths. We receive data on vital records from the National Center for Health Statistics (NCHS) and, until V2024, the FSCPE. NCHS data are derived from birth and death certificates across the United States. Birth data include date of birth, sex of child, residence of mother, and race and Hispanic origin of both mother and father. Death data include residence, age, sex, race, and Hispanic origin of each decedent, and the date each death occurred.

**Net Domestic Migration**

The third major component of the balancing equation is migration. Migration can be divided into net domestic migration (NDM) within the United States and net international migration (NIM) between the United States and elsewhere. The Population Estimates Program calculates domestic migration using several data sources and methods depending on the age group in question and the level of characteristic detail required.

For state and county total estimates, we calculate county-specific net domestic migration based on four data sources:

1.  Internal Revenue Service (IRS) tax return data for ages 0 to 64;
2.  Medicare enrollment data from Centers for Medicare and Medicaid Services (CMS) for the population aged 65 and older;
3.  Social Security Administration’s (SSA) Numerical Identification File (NUMIDENT) for all ages; and
4.  Change in the GQ population (described in the group quarters section of this document).

To understand how each component is, and has, contributed to population change, we will split up the components in order to fully explore their contribution.

<br>

# Population

Let's first explore what the population trends have been over the last 15 years.

<br>

## Trends

The following charts provide the change in population from 2000 to 2023.

Although the state has grown in population by 16.3% since 2000, that growth hasn't been even across the state, nor has it been even across rurality. Our most rural counties of Minnesota that are not categorized as "recreational" have experienced a population loss of 13.2% whereas entirely rural counties that are "recreational" have experienced a population increase of 2.4%.

In addition, town/rural mix counties that are recreational have experienced an increase of 12.4% in population compared to a loss of 1.4%.

Essentially, our most rural, non-recreational counties have experienced population loss.

When looking at the planning region level, all regions have experienced positive population growth, but within those regions that isn't the case. There is population losses concentrated in counties located in Southwest Minnesota, and along the very northwest board of Minnesota.

<br>

::: panel-tabset
### Minnesota

Since 2000, the Minnesota population has increased pretty consistently. By 2023, the population was 16% higher than in 2000.

<br>

```{r pop trend mn}
pop.trend.mn <- master.comp.change %>%
  group_by(year) %>%
  summarize(pop.est = sum(pop.est)) %>%
  ungroup() %>%
  mutate(pop.change.index = (pop.est - pop.est[year == min(year)]) / pop.est[year == min(year)],
         data_id = seq(n()))


pop.trend.mn.plot <- ggplot(pop.trend.mn, aes(year, pop.change.index)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(year, "\nPopulation estimate: ", comma(pop.est), "\nChange in population since ", min(pop.trend.mn$year), ": ", percent(pop.change.index, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = paste("Change in population since ", min(pop.trend.mn$year), sep = ""))+
  geom_label_repel(data = filter(pop.trend.mn, year == max(year)), aes(label = percent(pop.change.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  theme(legend.position = "none",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = pop.trend.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### RUCA

There are two points here.

First, population growth is occurring in all RUCA categories except Entirely rural. The more urban a county is, the larger the increase in population since 2000.

Second, the Census Bureau continues to underestimate the population performance of rural county groups. This is why there are consistent increases/up-adjusting in population change at the 2011 and 2021 values. The 2010 and 2020 populations are estimates and when they begin the new population estimates for the new decade, they are always adjusting them up.

<br>

```{r pop trend ruca}
pop.trend.ruca <- master.comp.change %>%
  group_by(year, Dem_Desc) %>%
  summarize(pop.est = sum(pop.est)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(pop.change.index = (pop.est - pop.est[year == min(year)]) / pop.est[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))


pop.trend.ruca.plot <- ggplot(pop.trend.ruca, aes(year, pop.change.index, color = Dem_Desc)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nPopulation estimate: ", comma(pop.est), "\nChange in population since ", min(pop.trend.ruca$year), ": ", percent(pop.change.index, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = paste("Change in population since ", min(pop.trend.ruca$year), sep = ""))+
  geom_label_repel(data = filter(pop.trend.ruca, year == max(year)), aes(label = percent(pop.change.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  scale_color_manual(values = color.ruca,
                     guide = guide_legend(ncol = 2)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = pop.trend.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### County recreational

**Entirely rural**

The counties that are entirely rural but not recreational are experiencing the largest declines while the entirely rural - recreational are seeing some modest population gains.

**Town/rural mix**

Town rural mix counties that are not recreational are seeing some minor population declines while the recreational counties are experiencing very large population gains.

**Urban/town/rural mix**

Urban town rural mix counties that are not recreational are experiencing the second highest population gains at 17.8% while the counties that are recreational are seeing modest growth at 3.4%.

<br>

```{r pop trend typology}
pop.trend.rec <- master.comp.change %>%
  group_by(year, recreational) %>%
  summarize(pop.est = sum(pop.est)) %>%
  ungroup() %>%
  group_by(recreational) %>%
  mutate(pop.change.index = (pop.est - pop.est[year == min(year)]) / pop.est[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))


pop.trend.rec.plot <- ggplot(pop.trend.rec, aes(year, pop.change.index, color = recreational)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(recreational, "\nYear: ", year, "\nPopulation estimate: ", comma(pop.est), "\nChange in population since ", min(pop.trend.rec$year), ": ", percent(pop.change.index, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = paste("Change in population since ", min(pop.trend.rec$year), sep = ""))+
  geom_label_repel(data = filter(pop.trend.rec, year == max(year)), aes(label = percent(pop.change.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  scale_color_manual(values = c("#006d2c", "#66c2a4", "#045a8d", "#74a9cf", "#993404", "#fe9929", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9),
        legend.text = element_text(size = 10))

girafe(ggobj = pop.trend.rec.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### Planning Region

Interestingly, all of the planning regions have a higher population in 2023 than they did in 2000. The largest population growth has occurred in Central Minnesota with 30%, followed by the seven county metro with 19%. Southeast and Northwest have experienced population growth of a little over 10% while Northeast and Southwest are about even.

<br>

```{r pop trend pr}
pop.trend.pr <- master.comp.change %>%
  group_by(year, planning.region) %>%
  summarize(pop.est = sum(pop.est)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(pop.change.index = (pop.est - pop.est[year == min(year)]) / pop.est[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))


pop.trend.pr.plot <- ggplot(pop.trend.pr, aes(year, pop.change.index, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nPopulation estimate: ", comma(pop.est), "\nChange in population since ", min(pop.trend.pr$year), ": ", percent(pop.change.index, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = paste("Change in population since ", min(pop.trend.pr$year), sep = ""))+
  geom_label_repel(data = filter(pop.trend.pr, year == max(year)), aes(label = percent(pop.change.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9),
        legend.text = element_text(size = 10))

girafe(ggobj = pop.trend.pr.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### EDR

**Northwest**

All EDRs are experiencing population growth except for EDR 1 which has lost 6.5% of it's population since 2000.

**Northeast**

Minor population growth.

**Central**

Tremendous population growth in all EDRs except Southwest Central which is minimal at 2.2%.

**Southwest**

EDR 9 is the only EDR with population growth at 6.7% more since 2000. EDR 6W and 8 are experiencing loss. EDR 6W in particular has lost 13.5% of it's population since 2000.

**Southeast**

13% growth.

<br>

```{r pop trend edr}
pop.trend.edr <- master.comp.change %>%
  group_by(year, edr, planning.region) %>%
  summarize(pop.est = sum(pop.est)) %>%
  ungroup() %>%
  group_by(edr, planning.region) %>%
  mutate(pop.change.index = (pop.est - pop.est[year == min(year)]) / pop.est[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))


pop.trend.edr.plot <- ggplot(pop.trend.edr, aes(year, pop.change.index, color = edr)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free_y") +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nPopulation estimate: ", comma(pop.est), "\nChange in population since ", min(pop.trend.edr$year), ": ", percent(pop.change.index, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = paste("Change in population since ", min(pop.trend.edr$year), sep = ""))+
  geom_label_repel(data = filter(pop.trend.edr, year == max(year)), aes(label = percent(pop.change.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9),
        legend.text = element_text(size = 10))

girafe(ggobj = pop.trend.edr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### County

The map below shows that the population is lower in 2023 compared to 2000 for much of Southwest Minnesota, along the border in Northwest, and in the arrowhead.

<br>

```{r pop trend county}
pop.trend.county <- master.comp.change %>%
  group_by(countyfp) %>%
  mutate(pop.change.index = (pop.est - pop.est[year == min(year)]) / pop.est[year == min(year)]) %>%
  ungroup() %>%
  mutate(pop.change.index.bins = cut(pop.change.index,
                                     breaks = c(-1, -.125, 0, .125, .25, 1),
                                     labels = c("-25.5% to -12.5%", "-12.5% to 0%", "0% to 12.5%", "12.5% to 25.0%", "25.0% or more"))) %>%
  filter(year == max(year)) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp") %>%
  mutate(data_id = seq(n()))

pop.trend.county.map <- ggplot(pop.trend.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pop.change.index.bins, data_id = countyfp, tooltip = paste(Name, "\nYear: ", year, "\nEstimated population: ", comma(pop.est), "\nChange in population since 2000: ", percent(pop.change.index, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("#d73027", "#fc8d59", "#e0f3f8", "#91bfdb", "#4575b4")) +
  labs(title = "Change in population since 2000") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 16))

girafe(ggobj = pop.trend.county.map, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>
:::

The next question is whether one of the components of population change (natural vs. migration) is driving these trends. Let's start with migration.

# Migration

The charts below provide two pieces of information. The dots provide the net number of individuals that in-migrated (above 0) or out-migration (below 0). The second piece of information is are the trend lines that smooth this data to provide the general trajectory of the data using LOESS stats. LOESS in statistics stands for "**Locally Estimated Scatterplot Smoothing**," which is a non-parametric statistical method used to fit a smooth curve through a scatterplot of data points by performing local regressions at different points along the data, giving more weight to points closer to the point being estimated; essentially, it helps visualize the relationship between two variables without assuming a specific functional form between them. 

The trends show a couple of themes;

1.  Minnesota on a whole is struggling with migration trends. It does well internationally with consistent in-migration between 10,000 and 15,000 individuals. However, this growth is entirely wiped out by the lost in net domestic migration. This is especially true since 2015.
2.  Hennepin and Ramsey have struggled, and are continuing to struggle, with domestic migration. The pandemic has not helped it.
3.  The western suburbs along with central I94 corridor have been pretty consistently experiencing a modest net in-migration and have been relatively stable.
4.  Greater MN has experienced a significant turn around in terms of domestic migration. The 2000s to 2010s saw them experiencing a worsening net out-migration but has since turned around.

<br>

::: panel-tabset
### Minnesota

The chart below shows that if it wasn't for international migration, Minnesota would be a net exporter of people. Domestic migration is consistently a net out-migration while international migration is between 10,000 and 20,000 net in-migration.

<br>

```{r chart migration index mn}
mig.mn <- master.comp.change %>%
  group_by(year) %>%
  summarize(pop.est = sum(pop.est),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration),
            net.migration = sum(net.migration)) %>%
  ungroup() %>%
  mutate(data_id = seq(n())) %>%
  pivot_longer(names_to = "mig.type", values_to = "pop", int.migration:net.migration) %>%
  mutate(mig.type = fct_relevel(mig.type, "int.migration", "dom.migration", "net.migration"))

mig.mn.plot <- ggplot(mig.mn, aes(year, pop, color = mig.type)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3, method = NULL) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(year, "\nType of migration: ", mig.type, "\nPopulation change: ", comma(pop), sep = ""))) +
  labs(x="", y = "", color="", title = "International, domestic, and net migration")+
  geom_label_repel(data = filter(mig.mn, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= c("#018571", "#a6611a", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

girafe(ggobj = mig.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### RUCA

The chart below shows that trends are changing.

**Domestic migration**

Rural areas of Minnesota were experiencing a growing net out-migration from 2000 to 2010. However, that began to change and by 2017 rural areas were experiencing a net in-migration. The opposite is true for entirely urban areas. From 2000 to 2010, domestic migration was improving to the point where experiencing a net in-migration by 2010. However, that trend reversed and they are now trending down to the point where they are experiencing a net out-migration.

**International migration**

International migration plays a minor role in rural areas of Minnesota, but is significant in our urban areas, and is consistenyl a net in-migration for these county groups.

<br>

```{r chart migration index ruca}
mig.ruca <- master.comp.change %>%
  group_by(year, Dem_Desc) %>%
  summarize(pop.est = sum(pop.est),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration),
            net.migration = sum(net.migration)) %>%
  ungroup() %>%
  mutate(data_id = seq(n())) %>%
  pivot_longer(names_to = "mig.type", values_to = "pop", int.migration:net.migration) %>%
  mutate(mig.type = fct_relevel(mig.type, "int.migration", "dom.migration", "net.migration"))


mig.ruca.plot <- ggplot(mig.ruca, aes(year, pop, color = mig.type)) +
  facet_wrap(~Dem_Desc, ncol = 2, scales = "free_y") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nType of migration: ", mig.type, "\nPopulation change: ", comma(pop), sep = ""))) +
  labs(x="", y = "", color="", title = "International, domestic, and net migration")+
  geom_label_repel(data = filter(mig.ruca, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#018571", "#a6611a", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = mig.ruca.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### Recreational

**Entirely rural** The recreational version of this county group has done significantly better in terms of net in-migration.

**Town/rural mix** Similary to the entirely rural folks, the town/rural mix counties that are recreational have done significantly better in migration.

**Urban/town/rural mix** REcretaional is doing better.

<br>

```{r chart migration index recreational}
mig.rec <- master.comp.change %>%
  group_by(year, recreational) %>%
  summarize(pop.est = sum(pop.est),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration),
            net.migration = sum(net.migration)) %>%
  ungroup() %>%
  mutate(data_id = seq(n())) %>%
  pivot_longer(names_to = "mig.type", values_to = "pop", int.migration:net.migration) %>%
  mutate(mig.type = fct_relevel(mig.type, "int.migration", "dom.migration", "net.migration"))


mig.rec.plot <- ggplot(mig.rec, aes(year, pop, color = mig.type)) +
  facet_wrap(~recreational, ncol = 2, scales = "free_y") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(recreational, "\nYear: ", year, "\nType of migration: ", mig.type, "\nPopulation change: ", comma(pop), sep = ""))) +
  labs(x="", y = "", color="", title = "International, domestic, and net migration")+
  geom_label_repel(data = filter(mig.rec, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#018571", "#a6611a", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = mig.rec.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### Planning Region

Planning regions in Greater Minnesota follow the patterns we have seen for rural counties - worsening domestic migration through the 2000s, with slow improvement starting around 2012.

<br>

```{r chart migration index planning region}
mig.pr <- master.comp.change %>%
  group_by(year, planning.region) %>%
  summarize(pop.est = sum(pop.est),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration),
            net.migration = sum(net.migration)) %>%
  ungroup() %>%
  mutate(data_id = seq(n())) %>%
  pivot_longer(names_to = "mig.type", values_to = "pop", int.migration:net.migration) %>%
  mutate(mig.type = fct_relevel(mig.type, "int.migration", "dom.migration", "net.migration"))


mig.pr.plot <- ggplot(mig.pr, aes(year, pop, color = mig.type)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free_y") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nType of migration: ", mig.type, "\nPopulation change: ", comma(pop), sep = ""))) +
  labs(x="", y = "", color="", title = "International, domestic, and net migration")+
  geom_label_repel(data = filter(mig.pr, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#018571", "#a6611a", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = mig.pr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### EDR

Most EDRs are following the similar pattern except for the following;

-   EDR 1 Northwest: it's been pretty rough
-   EDR 8 Southwest: it's been pretty rough

<br>

```{r chart migration index edr}
mig.edr <- master.comp.change %>%
  group_by(year, edr) %>%
  summarize(pop.est = sum(pop.est),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration),
            net.migration = sum(net.migration)) %>%
  ungroup() %>%
  mutate(data_id = seq(n())) %>%
  pivot_longer(names_to = "mig.type", values_to = "pop", int.migration:net.migration) %>%
  mutate(mig.type = fct_relevel(mig.type, "int.migration", "dom.migration", "net.migration"))


mig.edr.plot <- ggplot(mig.edr, aes(year, pop, color = mig.type)) +
  facet_wrap(~edr, ncol = 2, scales = "free_y") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nType of migration: ", mig.type, "\nPopulation change: ", comma(pop), sep = ""))) +
  labs(x="", y = "", color="", title = "International, domestic, and net migration")+
  geom_label_repel(data = filter(mig.edr, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#018571", "#a6611a", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = mig.edr.plot, width_svg = 7, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### County

These maps are really interesting. They show a couple of things;

**International** International migration makes up a pretty small percentage of a county's total population, but the maps show that more and more counties have a positive net-migration of international individuals.

**Domestic** This shows that rural counties have improved significantly in net domestic migration. There are more rural counties experiencing a net domestic in-migration of individuals by the 2021-2023 timeframe, and counties that are still experiencing a net out-migration are less severe. Lastly, Hennepin and Ramsey are net out-migration counties now.

**Net migration** Same as domestic. Very similar. One nuance is that some of the more severe DOMESTIC out-migration counties have less severe NET total migration due to positive international migration.

<br>

```{r chart migration index county}
mig.county <- master.comp.change %>%
  filter(year > 2000) %>%
  select(year, countyfp, Name, pop.est, int.migration, dom.migration, net.migration) %>%
  mutate(data_id = seq(n()),
         time.group = ifelse(year < 2006, "2001-2005",
                             ifelse(year > 2005 & year < 2011, "2006-2010",
                                    ifelse(year > 2010 & year < 2016, "2011-2015",
                                           ifelse(year > 2015 & year < 2021, "2016-2020", "2021-2023"))))) %>%
  group_by(time.group, countyfp, Name) %>%
  summarize(pop.est.mean = round(mean(pop.est)),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration),
            net.migration = sum(net.migration)) %>%
  pivot_longer(names_to = "mig.type", values_to = "pop", int.migration:net.migration) %>%
  mutate(mig.type = fct_relevel(mig.type, "int.migration", "dom.migration", "net.migration"),
         pos.neg = ifelse(pop <= 0, "Net out", "Net in"),
         annual.pop = ifelse(time.group == "2021-2023", round(pop/3), round(pop/5)),
         pct.pop.est.mean = annual.pop / pop.est.mean,
         pct.pop.est.mean.bins = cut(pct.pop.est.mean,
                                     breaks = c(-1, -.02, -.01, 0, .01, .02, 1),
                                     labels = c("-3% to -2%", "-2% to -1%", "-1% to 0%", "0% to 1%", "1% to 2%", "2% to 3%"))) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")

int.mig.county.map <- ggplot(data = filter(mig.county, mig.type == "int.migration")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.pop.est.mean.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nType of migration: ", "\nEstimated mean population during time period: ", comma(pop.est.mean), mig.type, "\nChange in migration during time period: ", comma(pop), "\nPercent of estimated population: ", percent(pct.pop.est.mean, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-3% to -2%" = "#d73027", "-2% to -1%" = "#fc8d59", "-1% to 0%" = "#fee090", "0% to 1%" = "#e0f3f8", "1% to 2%" = "#91bfdb", "2% to 3%" = "#4575b4")) +
  labs(title = "Net in or out international migration") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))


dom.mig.county.map <- ggplot(data = filter(mig.county, mig.type == "dom.migration")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.pop.est.mean.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nType of migration: ", "\nEstimated mean population during time frame: ", comma(pop.est.mean), mig.type, "\nChange in migration during time period: ", comma(pop), "\nPercent of estimated population: ", percent(pct.pop.est.mean, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-3% to -2%" = "#d73027", "-2% to -1%" = "#fc8d59", "-1% to 0%" = "#fee090", "0% to 1%" = "#e0f3f8", "1% to 2%" = "#91bfdb", "2% to 3%" = "#4575b4")) +
  labs(title = "Net in or out domestic migration") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))


net.mig.county.map <- ggplot(data = filter(mig.county, mig.type == "net.migration")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.pop.est.mean.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nType of migration: ", mig.type, "\nChange in migration during time period: ", comma(pop), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-3% to -2%" = "#d73027", "-2% to -1%" = "#fc8d59", "-1% to 0%" = "#fee090", "0% to 1%" = "#e0f3f8", "1% to 2%" = "#91bfdb", "2% to 3%" = "#4575b4")) +
  labs(title = "Net in or out total migration") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

legend <- get_plot_component(net.mig.county.map, "guide-box-bottom", return_all = TRUE)


girafe(ggobj = plot_grid(int.mig.county.map + theme(legend.position = "none"), dom.mig.county.map + theme(legend.position = "none"), net.mig.county.map + theme(legend.position = "none"), legend, ncol = 1, nrow = 4, rel_heights = c(1,1,1,.2)), width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE)) 



```

<br>
:::

<br>

# Natural Change

This has tended to play a more prominent role in population change in Minnesota. Let's take a look at the numbers and trends.

::: panel-tabset
## Minnesota

Minnesota is facing an uphill battle when it comes to natural change. Deaths are increasing while births are decreasing steadily. In the early 2000s, there were typically between 30,000 and 40,000 more births than deaths. Now, Minnesota is only experiencing 14,000 more births than deaths. A decline of `r percent((14000-30000) / 30000, accuracy = .1)`.

<br>

```{r}
nat.change.mn <- master.comp.change %>%
  group_by(year) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            natural.change = sum(natural.change)) %>%
  ungroup() %>%
  pivot_longer(names_to = "nat.change.type", values_to = "pop", births:natural.change) %>%
  mutate(nat.change.type = fct_relevel(nat.change.type, "births", "deaths", "natural.change")) %>%
  mutate(data_id = seq(n()))

nat.change.mn.plot <- ggplot(data = filter(nat.change.mn, year > 2000), aes(year, pop, color = nat.change.type)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nComponent of natural change: ", nat.change.type, "\nNumber: ", comma(pop), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Components of natural change - trends and numbers")+
  geom_label_repel(data = filter(nat.change.mn, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#2c7bb6", "#d7191c", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = nat.change.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

## RUCA

Our most rural counties have experienced more deaths than births over the last couple of decades, and it's going to get worse. From the early 2000s, there were around 250 more deaths than births in these counties. This decade, it has increase to over 500 more deaths than births.

Town/rural mix counties typically had a bit more births than deaths, but that has completely changed so far this decade and we are now experiencing more deaths than births.

Urban/town/rural mix counties experienced significantly more births than deaths in the arly 2000s, but that has completely disappeared and they are now about even.

The entirely urban counties have experienced significantly more births than deaths. But that has begin to lessen. In the early 2000s, these counties were experiencing about 25,000 more births than deaths but has now shrunk to 15,000.

<br>

```{r}
nat.change.ruca <- master.comp.change %>%
  group_by(year, Dem_Desc) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            natural.change = sum(natural.change)) %>%
  ungroup() %>%
  pivot_longer(names_to = "nat.change.type", values_to = "pop", births:natural.change) %>%
  mutate(nat.change.type = fct_relevel(nat.change.type, "births", "deaths", "natural.change")) %>%
  mutate(data_id = seq(n()))

nat.change.ruca.plot <- ggplot(data = filter(nat.change.ruca, year > 2000), aes(year, pop, color = nat.change.type)) +
  facet_wrap(~Dem_Desc, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nComponent of natural change: ", nat.change.type, "\nNumber: ", comma(pop), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Components of natural change - trends and numbers")+
  geom_label_repel(data = filter(nat.change.ruca, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#2c7bb6", "#d7191c", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = nat.change.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## Recreational

This is super interesting. So even though recreational counties typically do well in migration, they don't do as well in natural change. For entirely rural counties, and town/rural mix and urban/town/rural mix counties, there are significantly more deaths than births in these counties and it's getting worse. For the non-recreational counties, they are a bit more even.

<br>

```{r}
nat.change.rec <- master.comp.change %>%
  group_by(year, recreational) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            natural.change = sum(natural.change)) %>%
  ungroup() %>%
  pivot_longer(names_to = "nat.change.type", values_to = "pop", births:natural.change) %>%
  mutate(nat.change.type = fct_relevel(nat.change.type, "births", "deaths", "natural.change")) %>%
  mutate(data_id = seq(n()))

nat.change.rec.plot <- ggplot(data = filter(nat.change.rec, year > 2000), aes(year, pop, color = nat.change.type)) +
  facet_wrap(~recreational, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(recreational, "\nYear: ", year, "\nComponent of natural change: ", nat.change.type, "\nNumber: ", comma(pop), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Components of natural change - trends and numbers")+
  geom_label_repel(data = filter(nat.change.rec, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#2c7bb6", "#d7191c", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = nat.change.rec.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

**Northwest, Southwest, Northeast**

Both Northwest and Southwest have just turned the corner and after decades of experiencing more births than deaths, they are now having more deaths than births. Northeast, on the other hand, turned that corner around 2010.

**Central, Seven County Metro, Southeast**

These three planning regions continue to experience more births than deaths, but that is beginning to decline as births steadily decrease and deaths steadily increase.

<br>

```{r}
nat.change.pr <- master.comp.change %>%
  group_by(year, planning.region) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            natural.change = sum(natural.change)) %>%
  ungroup() %>%
  pivot_longer(names_to = "nat.change.type", values_to = "pop", births:natural.change) %>%
  mutate(nat.change.type = fct_relevel(nat.change.type, "births", "deaths", "natural.change")) %>%
  mutate(data_id = seq(n()))

nat.change.pr.plot <- ggplot(data = filter(nat.change.pr, year > 2000), aes(year, pop, color = nat.change.type)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nComponent of natural change: ", nat.change.type, "\nNumber: ", comma(pop), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Components of natural change - trends and numbers")+
  geom_label_repel(data = filter(nat.change.pr, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#2c7bb6", "#d7191c", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = nat.change.pr.plot, width_svg = 7, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## EDR

**Northwest**

EDR 1,2,4,5 have identical trends. They were experiencing more births than deaths until relatively recently when it flipped. These regions are all now experiencing slightly more deaths than births.

**Northeast**

Same as planning region.

**Central**

EDR 6E and EDR 7E are all now experiencing more deaths than births. EDR 7W is experiencing significantly more births than deaths.

**Seven County Mpls-St. Paul**

Same as planning region.

**Southwest**

EDR 6W has been having nearly identical births and deaths for 20 years but has now entered into an era of more deaths than births.

EDR 8 and 9 did have significantly more births but now is about even.

**Southeast**

Same as planning region.

<br>

```{r}
nat.change.edr <- master.comp.change %>%
  group_by(year, edr) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            natural.change = sum(natural.change)) %>%
  ungroup() %>%
  pivot_longer(names_to = "nat.change.type", values_to = "pop", births:natural.change) %>%
  mutate(nat.change.type = fct_relevel(nat.change.type, "births", "deaths", "natural.change")) %>%
  mutate(data_id = seq(n()))

nat.change.edr.plot <- ggplot(data = filter(nat.change.edr, year > 2000), aes(year, pop, color = nat.change.type)) +
  facet_wrap(~edr, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nComponent of natural change: ", nat.change.type, "\nNumber: ", comma(pop), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Components of natural change - trends and numbers")+
  geom_label_repel(data = filter(nat.change.edr, year == max(year)), aes(label = comma(pop)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= c("#2c7bb6", "#d7191c", "black"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = nat.change.edr.plot, width_svg = 7, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## County

The following maps provide a pretty clear picture on the trends in the components of natural change. The percent of annual births has been declining over time (becoming less blue), while deaths as a percent of population are increasing (becoming more red). The resulting natural change has been worsening due to these trends (becoming more orange).

<br>

```{r}
nat.change.county <- master.comp.change %>%
  filter(year > 2000) %>%
  select(year, countyfp, Name, pop.est, births, deaths, natural.change) %>%
  mutate(data_id = seq(n()),
         time.group = ifelse(year < 2006, "2001-2005",
                             ifelse(year > 2005 & year < 2011, "2006-2010",
                                    ifelse(year > 2010 & year < 2016, "2011-2015",
                                           ifelse(year > 2015 & year < 2021, "2016-2020", "2021-2023"))))) %>%
  group_by(time.group, countyfp, Name) %>%
  summarize(pop.est.mean = round(mean(pop.est)),
            births = sum(births),
            deaths = sum(deaths),
            natural.change = sum(natural.change)) %>%
  pivot_longer(names_to = "natural.change.type", values_to = "pop", births:natural.change) %>%
  mutate(mig.type = fct_relevel(natural.change.type, "births", "deaths", "natural.change"),
         annual.pop = ifelse(time.group == "2021-2023", round(pop/3), round(pop/5)),
         pct.pop.est.mean = annual.pop / pop.est.mean,
         pct.pop.est.mean = ifelse(natural.change.type == "deaths", pct.pop.est.mean * -1, pct.pop.est.mean)) %>%
  mutate(pct.pop.est.mean.bins = cut(pct.pop.est.mean,
                                     breaks = c(-1, -.01, 0, .01, 1),
                                     labels = c("-2% to -1%", "-1% to -0%", "0% to 1%", "1% to 2%"))) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")

births.county.map <- ggplot(data = filter(nat.change.county, natural.change.type == "births")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.pop.est.mean.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nType of natural change: ", natural.change.type, "\nEstimated mean population during time period: ", comma(pop.est.mean), "\nChange in natural change during time period: ", comma(pop), "\nPercent of estimated population: ", percent(pct.pop.est.mean, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-2% to -1%" = "#d73027", "-1% to -0%" = "#fc8d59", "0% to 1%" = "#e0f3f8", "1% to 2%" = "#4575b4")) +
  labs(title = "Annual births as a percent of population") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))


deaths.county.map <- ggplot(data = filter(nat.change.county, natural.change.type == "deaths")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.pop.est.mean.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nType of natural change: ", natural.change.type, "\nEstimated mean population during time frame: ", comma(pop.est.mean), "\nChange in natural change during time period: ", comma(pop), "\nPercent of estimated population: ", percent(pct.pop.est.mean, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-2% to -1%" = "#d73027", "-1% to -0%" = "#fc8d59", "0% to 1%" = "#e0f3f8", "1% to 2%" = "#4575b4")) +
  labs(title = "Annual deaths as a percent of population") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))


natural.change.county.map <- ggplot(data = filter(nat.change.county, natural.change.type == "natural.change")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.pop.est.mean.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nType of natural change: ", natural.change.type, "\nChange in natural change during time period: ", comma(pop), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-2% to -1%" = "#d73027", "-1% to -0%" = "#fc8d59", "0% to 1%" = "#e0f3f8", "1% to 2%" = "#4575b4")) +
  labs(title = "Annual natural change as a percent of population") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

legend <- get_plot_component(natural.change.county.map, "guide-box-bottom", return_all = TRUE)


girafe(ggobj = plot_grid(births.county.map + theme(legend.position = "none"), deaths.county.map + theme(legend.position = "none"), natural.change.county.map + theme(legend.position = "none"), legend, ncol = 1, nrow = 4, rel_heights = c(1,1,1,.2)), width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE)) 


```

<br>
:::

# What has largest impact so far?

The next question is what is having the greatest impact on population change currently? This can be hard because not only can population go up or down (negative or positive) but so can all the components. So if there is net out migration, yet natural change is positive and population is increasing, how do you measure the impact of the net out migration?

<br>

## Line charts

This first group is line charts indicating trends in the percentage of total population unit change that each component comprises. Each component would be positive, thus deaths and births each count equally as a unit of change.

The main theme is that deaths are becoming more prominent as a share of total population unit change. It's surpassing births in our most rural areas. In addition, domestic migration is becoming less harmful in rural areas, and in some cases, is contributing positively to total population unit change.

::: panel-tabset
<br>

### Minnesota

The chart below clearly shows that births has been and continues to be the largest contributor to total unit change in population. However, it is shrinking. There is significant growth in deaths as a share of total unit population change. Migration just isn't that big of a piece.

<br>

```{r}
comp.change.pct.total.change.mn <- master.comp.change %>%
  group_by(year) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration)) %>%
  ungroup() %>%
  pivot_longer(names_to = "component", values_to = "pop", births:dom.migration) %>%
  mutate(pop.pos = ifelse(pop < 0, pop*-1, pop)) %>%
  group_by(year) %>%
  mutate(total.change = sum(pop.pos)) %>%
  ungroup() %>%
  mutate(pct.total.change = pop / total.change,
         component = ifelse(component == "births", "Births",
                            ifelse(component == "deaths", "Deaths",
                                   ifelse(component == "dom.migration", "Domestic migration", "International migration"))),
         component = fct_relevel(component, "Births", "Deaths", "International migration", "Domestic migration"),
         data_id = seq(n()))


comp.change.pct.total.change.mn.plot <- ggplot(comp.change.pct.total.change.mn, aes(year, pct.total.change, color = component)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nTotal change units: ", comma(total.change), "\nComponent of change: ", component, "\nNumber of individuals: ", comma(pop), "\nPercent of total change units: ", percent(pct.total.change, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Minnesota - components of change as a percent of\ntotal change",
       subtitle = "Deaths becoming more prominent in total population change")+
  geom_label_repel(data = filter(comp.change.pct.total.change.mn, year %in% c(min(year), max(year))), aes(label = percent(pct.total.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values = c("#0571b0", "#ca0020", "#80cdc1", "#018571"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

girafe(ggobj = comp.change.pct.total.change.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### RUCA

**Entirely rural**

Births and deaths in our entirely rural counties have had a similar share of total unit change in population until about 2015. Since than, deaths has been increasing it's share of total unit change.

Interestingly, in the early 2000s, domestic migration was the largest contributor to total unit change in population with nearly 40% of individuals disappearing from those counties. That has improved significantly since that time frame.

**Town/rural mix**

Births was the largest contribution to total unit change in population but has since given way to deaths as the largest share. Migration makes up a pretty small percentage of the total unit change.

**Urban/town/rural mix**

Births made up nearly 50% of the entire unit change in population but that has decreased to 41%. Deaths has increased since that time frame. Domestic migration has gone up and down, but is now a positive share.

**Entirely urban**

Births continue to make up a sizable share of total unit change in population. Deaths are increasing though while domestic migration continues to be burdensome as well.

<br>

```{r}
comp.change.pct.total.change.ruca <- master.comp.change %>%
  group_by(year, Dem_Desc) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration)) %>%
  ungroup() %>%
  pivot_longer(names_to = "component", values_to = "pop", births:dom.migration) %>%
  mutate(pop.pos = ifelse(pop < 0, pop*-1, pop)) %>%
  group_by(year, Dem_Desc) %>%
  mutate(total.change = sum(pop.pos)) %>%
  ungroup() %>%
  mutate(pct.total.change = pop / total.change,
         component = ifelse(component == "births", "Births",
                            ifelse(component == "deaths", "Deaths",
                                   ifelse(component == "dom.migration", "Domestic migration", "International migration"))),
         component = fct_relevel(component, "Births", "Deaths", "International migration", "Domestic migration"),
         data_id = seq(n()))


comp.change.pct.total.change.ruca.plot <- ggplot(comp.change.pct.total.change.ruca, aes(year, pct.total.change, color = component)) +
  facet_wrap(~Dem_Desc, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nTotal change units: ", comma(total.change), "\nComponent of change: ", component, "\nNumber of individuals: ", comma(pop), "\nPercent of total change units: ", percent(pct.total.change, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Minnesota - components of change as a percent of\ntotal change",
       subtitle = "Deaths becoming more prominent in total population change")+
  geom_label_repel(data = filter(comp.change.pct.total.change.ruca, year %in% c(min(year), max(year))), aes(label = percent(pct.total.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values = c("#0571b0", "#ca0020", "#80cdc1", "#018571"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

girafe(ggobj = comp.change.pct.total.change.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### Recreational

**Entirely rural**

The recreational counties have had the most significant share of their total population unit change from deaths and is currently 54% of the total change. however, births and domestic migration are also sizable.

The non-recreational counties have seen a large increase in births and deaths as a share of the total population unit change while domestic migration has been slowly becoming less bad.

**Town/rural mix**

The recreational counties are experiencing death as a larger share of population unit change4 while births has declined. The domestic migration has increased significantly as well.

For non-recreational counties, births and death make up very similar shares of population change, while international migration has increased and the net out-domestic-migration has improved as well.

**Urban/town/rural mix**

In recreational counties, deaths has stated about the same while births has declined as a share and domestic migration has increased.

In non-recreational counties, births continues to be a major driver in population unit change with death increasing. Domestic migration has improved since 2010 as well.

<br>

```{r}
comp.change.pct.total.change.rec <- master.comp.change %>%
  group_by(year, recreational) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration)) %>%
  ungroup() %>%
  pivot_longer(names_to = "component", values_to = "pop", births:dom.migration) %>%
  mutate(pop.pos = ifelse(pop < 0, pop*-1, pop)) %>%
  group_by(year, recreational) %>%
  mutate(total.change = sum(pop.pos)) %>%
  ungroup() %>%
  mutate(pct.total.change = pop / total.change,
         component = ifelse(component == "births", "Births",
                            ifelse(component == "deaths", "Deaths",
                                   ifelse(component == "dom.migration", "Domestic migration", "International migration"))),
         component = fct_relevel(component, "Births", "Deaths", "International migration", "Domestic migration"),
         data_id = seq(n()))


comp.change.pct.total.change.rec.plot <- ggplot(comp.change.pct.total.change.rec, aes(year, pct.total.change, color = component)) +
  facet_wrap(~recreational, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(recreational, "\nYear: ", year, "\nTotal change units: ", comma(total.change), "\nComponent of change: ", component, "\nNumber of individuals: ", comma(pop), "\nPercent of total change units: ", percent(pct.total.change, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Recreational counties - components of change as a percent of\ntotal change",
       subtitle = "Deaths becoming more prominent in total population change")+
  geom_label_repel(data = filter(comp.change.pct.total.change.rec, year %in% c(min(year), max(year))), aes(label = percent(pct.total.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values = c("#0571b0", "#ca0020", "#80cdc1", "#018571"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

girafe(ggobj = comp.change.pct.total.change.rec.plot, width_svg = 7, height_svg = 12) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))
```

<br>

### Planning Region

**Northwest, Central, Northeast**

These planning regions are beginning to experience more deaths than births as a share of population unit change while domestic migration has improved significantly.

**Southwest**

Southwest has even births and deaths as a share of population change while international migration has increased and domestic migration has improved.

**Southeast, Seven County Metro**

Both regions have declining births as a share of population change while domestic migration has not been great. International migration continues to make up a sizable portion, however.

<br>

```{r}
comp.change.pct.total.change.pr <- master.comp.change %>%
  group_by(year, planning.region) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration)) %>%
  ungroup() %>%
  pivot_longer(names_to = "component", values_to = "pop", births:dom.migration) %>%
  mutate(pop.pos = ifelse(pop < 0, pop*-1, pop)) %>%
  group_by(year, planning.region) %>%
  mutate(total.change = sum(pop.pos)) %>%
  ungroup() %>%
  mutate(pct.total.change = pop / total.change,
         component = ifelse(component == "births", "Births",
                            ifelse(component == "deaths", "Deaths",
                                   ifelse(component == "dom.migration", "Domestic migration", "International migration"))),
         component = fct_relevel(component, "Births", "Deaths", "International migration", "Domestic migration"),
         data_id = seq(n()))


comp.change.pct.total.change.pr.plot <- ggplot(comp.change.pct.total.change.pr, aes(year, pct.total.change, color = component)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nTotal change units: ", comma(total.change), "\nComponent of change: ", component, "\nNumber of individuals: ", comma(pop), "\nPercent of total change units: ", percent(pct.total.change, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Recreational counties - components of change as a percent of\ntotal change",
       subtitle = "Deaths becoming more prominent in total population change")+
  geom_label_repel(data = filter(comp.change.pct.total.change.pr, year %in% c(min(year), max(year))), aes(label = percent(pct.total.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values = c("#0571b0", "#ca0020", "#80cdc1", "#018571"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

girafe(ggobj = comp.change.pct.total.change.pr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))
```

<br>

### EDR

**EDR 1, 2, 4, 5**

These EDRs have a similar pattern - births are beginning to break even with deaths as a share of population change. Domestic migration has either improved but still net out-migration (EDR 1) or are increasing the share towards positive population change (EDR 2, 4, 5).

**EDR 6E, 7w, 7E**

EDR 6E and 7E each have even births and deaths as a share of population change. 7E has significantly better migration numbers compared to 6E, although international migration has been very helpful for 6E.

EDR 7W has significantly larger percentage of births. In the early 2000s, domestic migration was a huge driver but not has slowed a lot. Deaths are increasing significantly as a share of population change.

**EDR 6W, 8, 9**

All three have a declining share of population change going towards births, and increasing deaths as a share of pop change. In addition, domestic migration continues to be a net out, but has improved. International migration contineus to be a larger share as well.

<br>

```{r}
comp.change.pct.total.change.edr <- master.comp.change %>%
  group_by(year, edr) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration)) %>%
  ungroup() %>%
  pivot_longer(names_to = "component", values_to = "pop", births:dom.migration) %>%
  mutate(pop.pos = ifelse(pop < 0, pop*-1, pop)) %>%
  group_by(year, edr) %>%
  mutate(total.change = sum(pop.pos)) %>%
  ungroup() %>%
  mutate(pct.total.change = pop / total.change,
         component = ifelse(component == "births", "Births",
                            ifelse(component == "deaths", "Deaths",
                                   ifelse(component == "dom.migration", "Domestic migration", "International migration"))),
         component = fct_relevel(component, "Births", "Deaths", "International migration", "Domestic migration"),
         data_id = seq(n()))


comp.change.pct.total.change.edr.plot <- ggplot(comp.change.pct.total.change.edr, aes(year, pct.total.change, color = component)) +
  facet_wrap(~edr, ncol = 2, scales = "free") +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 2, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nTotal change units: ", comma(total.change), "\nComponent of change: ", component, "\nNumber of individuals: ", comma(pop), "\nPercent of total change units: ", percent(pct.total.change, accuracy = .1), sep = ""))) +
  labs(x="", 
       y = "", 
       color="", 
       title = "Recreational counties - components of change as a percent of\ntotal change",
       subtitle = "Deaths becoming more prominent in total population change")+
  geom_label_repel(data = filter(comp.change.pct.total.change.edr, year %in% c(min(year), max(year))), aes(label = percent(pct.total.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values = c("#0571b0", "#ca0020", "#80cdc1", "#018571"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

girafe(ggobj = comp.change.pct.total.change.edr.plot, width_svg = 7, height_svg = 17) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))
```

<br>

### County

The maps below show a few key themes;

1.  Births are declining as a percentage of total population unit change.
2.  Deaths are increasing as a percentage of total population unit change.
3.  International migration makes up less than 25% of total population change across Minnesota.
4.  Domestic out-migration is becoming less severe across rural Minnesota while also changing to a net in-migration.

<br>

```{r}
comp.change.pct.total.change.county <- master.comp.change %>%
  filter(year > 2000) %>%
  select(year, countyfp, Name, births, deaths, int.migration, dom.migration) %>%
  mutate(data_id = seq(n()),
         time.group = ifelse(year < 2006, "2001-2005",
                             ifelse(year > 2005 & year < 2011, "2006-2010",
                                    ifelse(year > 2010 & year < 2016, "2011-2015",
                                           ifelse(year > 2015 & year < 2021, "2016-2020", "2021-2023"))))) %>%
  group_by(time.group, countyfp, Name) %>%
  summarize(births = sum(births),
            deaths = sum(deaths),
            int.migration = sum(int.migration),
            dom.migration = sum(dom.migration)) %>%
  pivot_longer(names_to = "component", values_to = "pop", births:dom.migration) %>%
  mutate(pos.pop = ifelse(pop < 0, pop*-1, pop)) %>%
  group_by(time.group, countyfp) %>%
  mutate(total.pop.change = sum(pos.pop)) %>%
  ungroup() %>%
  mutate(pct.total.pop.change = pop / total.pop.change) %>%
  group_by(time.group, countyfp) %>%
  arrange(desc(pct.total.pop.change)) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  mutate(component = ifelse(component == "births", "Births",
                            ifelse(component == "deaths", "Deaths",
                                   ifelse(component == "int.migration", "International migration", "Domestic migration"))),
         component = fct_relevel(component, "Births", "Deaths", "International migration", "Domestic migration"),
         time.group = fct_relevel(time.group, "2001-2005", "2006-2010", "2011-2015", "2016-2020", "2021-2023"),
         pct.total.pop.change = ifelse(component == "Deaths", pct.total.pop.change *-1, pct.total.pop.change),
         pct.total.pop.change.bins = cut(pct.total.pop.change,
                                         breaks = c(-1, -.5, -.25, 0, .25, .5, 1),
                                         labels = c("-75% to -50%", "-50% to -25%", "-25% to -0%", "0% to 25%", "25% to 50%", "50% to 75%"))) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")


births.pct.total.change.county.map <- ggplot(data = filter(comp.change.pct.total.change.county, component == "Births")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.total.pop.change.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nComponent: ", component, "\nNumber of individuals: ", comma(pop), "\nTotal population change units during time period: ", comma(total.pop.change), "\nComponent as percentage of total population change units: ", percent(pct.total.pop.change, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-75% to -50%" = "#b2182b", "-50% to -25%" = "#ef8a62", "-25% to -0%" = "#fddbc7", "0% to 25%" = "#d1e5f0", "25% to 50%" = "#67a9cf", "50% to 75%" = "#2166ac")) +
  labs(title = "Births as percent of total population unit change") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))


deaths.pct.total.change.county.map <- ggplot(data = filter(comp.change.pct.total.change.county, component == "Deaths")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.total.pop.change.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nComponent: ", component, "\nNumber of individuals: ", comma(pop), "\nTotal population change units during time period: ", comma(total.pop.change), "\nComponent as percentage of total population change units: ", percent(pct.total.pop.change, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-75% to -50%" = "#b2182b", "-50% to -25%" = "#ef8a62", "-25% to -0%" = "#fddbc7", "0% to 25%" = "#d1e5f0", "25% to 50%" = "#67a9cf", "50% to 75%" = "#2166ac")) +
  labs(title = "Deaths as percent of total population unit change") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

int.mig.pct.total.change.county.map <- ggplot(data = filter(comp.change.pct.total.change.county, component == "International migration")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.total.pop.change.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nComponent: ", component, "\nNumber of individuals: ", comma(pop), "\nTotal population change units during time period: ", comma(total.pop.change), "\nComponent as percentage of total population change units: ", percent(pct.total.pop.change, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-75% to -50%" = "#b2182b", "-50% to -25%" = "#ef8a62", "-25% to -0%" = "#fddbc7", "0% to 25%" = "#d1e5f0", "25% to 50%" = "#67a9cf", "50% to 75%" = "#2166ac")) +
  labs(title = "International migration as percent of total population\nunit change") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))

dom.mig.pct.total.change.county.map <- ggplot(data = filter(comp.change.pct.total.change.county, component == "Domestic migration")) +
  facet_wrap(~time.group, ncol = 5) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.total.pop.change.bins, data_id = Name, tooltip = paste(Name, "\nTime period: ", time.group, "\nComponent: ", component, "\nNumber of individuals: ", comma(pop), "\nTotal population change units during time period: ", comma(total.pop.change), "\nComponent as percentage of total population change units: ", percent(pct.total.pop.change, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("-75% to -50%" = "#b2182b", "-50% to -25%" = "#ef8a62", "-25% to -0%" = "#fddbc7", "0% to 25%" = "#d1e5f0", "25% to 50%" = "#67a9cf", "50% to 75%" = "#2166ac")) +
  labs(title = "Domestic migration as percent of total population\nunit change") +
  theme(legend.position = "bottom",
        text = element_text(size = 16))



legend <- get_plot_component(dom.mig.pct.total.change.county.map, "guide-box-bottom", return_all = TRUE)


girafe(ggobj = plot_grid(births.pct.total.change.county.map + theme(legend.position = "none"), deaths.pct.total.change.county.map + theme(legend.position = "none"), int.mig.pct.total.change.county.map + theme(legend.position = "none"), dom.mig.pct.total.change.county.map + theme(legend.position = "none"), legend, ncol = 1, nrow = 5, rel_heights = c(1,1,1,1,.2)), width_svg = 7, height_svg = 12) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE)) 
```

<br>
:::

# 
